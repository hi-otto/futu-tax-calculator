# 计算方式说明

本文档详细说明富途税务计算器从账单中提取数据的方式及税务计算逻辑。

## 1. 数据来源

### 1.1 支持的账单类型

| 文件类型 | 文件名格式 | 用途 |
|---------|-----------|------|
| 年度账单 | `XXXX_年度账单_XXXXXXXX.xlsx` | 主要数据来源 |
| 利息股息汇总 | `XXXX_利息股息及其他收入汇总_XXXXXXXX.xlsx` | 辅助核对 |

### 1.2 年度账单工作表

年度账单 Excel 包含以下工作表，本工具解析其中部分：

| 工作表名称 | 是否解析 | 用途说明 |
|-----------|---------|---------|
| 账户信息 | ✅ | 提取账户基本信息 |
| 证券-持仓总览 | ✅ | 提取期初/期末持仓，用于核对 |
| 证券-交易流水 | ✅ | **核心**：计算资本利得 |
| 证券-资金进出 | ✅ | **核心**：提取股息、利息 |
| 证券-资金总览 | ❌ | 辅助信息，不参与计算 |
| 证券-资产进出 | ❌ | 辅助信息，不参与计算 |

## 2. 资本利得计算

### 2.1 数据来源
- **工作表**：`证券-交易流水`
- **提取字段**：
  - 成交时间、品类、代码名称、交易所/市场
  - 方向（买入/卖出/买入开仓/卖出平仓）
  - 币种、数量、价格、成交金额、总费用

### 2.2 计算方法

采用 **FIFO（先进先出）** 方法匹配买卖交易：

1. 将同一标的（相同代码+市场+币种+品类）的交易分组
2. **期初持仓**视为最早的"买入"（用于处理跨年持仓）
3. 当年买入按时间排序，排在期初持仓之后
4. 卖出时优先匹配最早的买入
5. 计算每笔匹配的盈亏：
   ```
   盈亏 = 卖出金额 - 买入金额 - 手续费
   ```

### 2.3 跨年持仓处理

**问题**：如果股票是去年买入、今年卖出，当年账单中没有买入记录，无法计算成本。

**解决方案**：使用期初持仓的市价作为估算成本。

- 期初持仓来自账单中的「证券-持仓总览」工作表
- 标记为"期初"的持仓会作为成本基础
- 在结果中会标记"估算成本"，提醒用户注意

**注意事项**：
- 期初市价 ≠ 实际买入价，存在一定误差
- 如需精确计算，应手动查找原始买入记录
- 这种误差对税务申报影响较小（成本越高，应税所得越低）

### 2.4 期权交易

- **识别方式**：品类字段为「期权」
- **乘数处理**：富途账单中的「成交金额」字段**已包含**100倍乘数
- **计算方式**：
  ```
  买入金额 = 成交金额（直接使用，无需额外计算）
  卖出金额 = 成交金额（直接使用，无需额外计算）
  ```
- **注意**：不需要用 `价格 × 数量 × 100`，成交金额已是最终金额

### 2.5 税额计算

```
应税所得 = max(0, 年度总盈亏)  // 盈亏可互抵，亏损不纳税
应纳税额 = 应税所得 × 20%
```

## 3. 股息税计算

### 3.1 数据来源
- **工作表**：`证券-资金进出`
- **识别规则**：通过备注字段匹配

### 3.2 股息识别

备注格式示例：
```
MRK 100.00000000 SHARES DIVIDENDS 0.77 USD PER SHARE
```

提取信息：
- 股票代码：MRK
- 股数：100
- 每股股息：0.77 USD
- 总股息：变动金额字段

### 3.3 预扣税识别

备注格式示例：
```
MRK 100.00000000 SHARES WITHHOLDING TAX -0.07700024 USD PER SHARE - TAX
```

提取信息：
- 预扣税金额：变动金额字段（绝对值）

### 3.4 税额计算

```
应纳税额 = 股息总额(CNY) × 20%
可抵免税额 = min(境外已扣税(CNY), 应纳税额)
实际应补税 = 应纳税额 - 可抵免税额
```

## 4. 利息税计算

### 4.1 数据来源
- **工作表**：`证券-资金进出`
- **当前状态**：暂未实现自动提取（货币基金利息识别复杂）

### 4.2 税额计算

```
应纳税额 = 利息总额(CNY) × 20%
```

## 5. 汇率转换

### 5.1 汇率来源
- 数据来源：中国国家外汇管理局
- 汇率日期：纳税年度12月31日

### 5.2 转换公式

汇率数据为「100外币兑人民币」格式：
```
人民币金额 = 外币金额 × 汇率 / 100
```

示例（2024年）：
- 100 USD = 718.84 CNY → 1 USD = 7.1884 CNY
- 100 HKD = 92.604 CNY → 1 HKD = 0.92604 CNY

## 6. 未识别记录

### 6.1 什么是未识别记录

在解析过程中，以下情况的数据行会被标记为「未识别」：

1. **交易流水**：有股票代码但缺少「方向」字段
2. **资金进出**：有变动金额但缺少「IN/OUT」方向

### 6.2 常见原因

- 账单导出不完整
- 富途账单格式更新
- 特殊交易类型（如公司行动）

### 6.3 处理建议

如果出现未识别记录：
1. 检查原始账单中对应行的数据
2. 确认是否为需要纳税的交易
3. 如需计入，可手动核算后加入

## 7. 计算结果核对

### 7.1 股息核对

**重要说明：**

富途「利息股息及其他收入汇总」文件中的数据是按**香港税务局汇率**换算成HKD的，而本工具计税使用的是**中国国家外汇管理局汇率**换算成CNY。

因此：
- 不能直接对比HKD金额和CNY金额
- 应该对比**原币种（如USD）**的总额

**核对方法：**

1. 查看本工具“股息明细”中的“按币种汇总”
2. 将USD总额乘以香港汇率（如 7.8035）
3. 结果应与富途汇总表中的HKD金额一致

**示例（以2024年为例）：**
- 本工具解析：股息 $390.84 USD
- 香港汇率：1 USD = 7.8035 HKD
- 换算：390.84 × 7.8035 = 3049.92 HKD
- 富途汇总表：2232.43 + 817.49 = 3049.92 HKD ✓

### 7.2 交易核对

- 资本利得明细中的每笔交易可在「证券-交易流水」中找到对应记录
- 买入/卖出价格、数量、费用应与原始数据一致

## 8. 滞纳金计算

### 8.1 法律依据

根据《税收征管法》规定，未按期缴纳税款的，从滞纳税款之日起，按日加收滞纳税款万分之五的滞纳金。

### 8.2 计算公式

```
滞纳金 = 应缴税款 × 滞纳天数 × 0.05%
```

### 8.3 重要日期

- **汇算截止日期**：次年6月30日（如2024年度汇算截止日为2025年6月30日）
- **滞纳金起算日**：从7月1日开始计算

### 8.4 示例

假设应缴税款 1000 元，逾期 30 天缴纳：
```
滞纳金 = 1000 × 30 × 0.05% = 15 元
合计应缴 = 1000 + 15 = 1015 元
```

## 9. 年度收益 vs 已实现盈亏

本工具计算的是**已实现盈亏**（用于税务申报），这与富途APP显示的**年度收益**是不同的指标。

### 9.1 已实现盈亏（税务口径）

```
已实现盈亏 = 卖出金额 - 买入金额 - 手续费
```

- 只计算当年实际卖出的交易
- 未卖出的持仓不计入
- 这是税务申报需要的数据

### 9.2 年度收益（富途口径）

```
年度收益 = 期末市值 - 期初市值 + 净现金流
```

- 包含未实现盈亏（持仓市值变化）
- 与富途APP显示的年度收益一致
- 不用于税务申报

### 9.3 两者差异

| 场景 | 已实现盈亏 | 年度收益 |
|------|-----------|---------|
| 持有股票，年内涨了10% | 0（未卖出） | +10%市值变化 |
| 卖出盈利股票 | +盈利金额 | +盈利金额 |
| 年初买入，年末浮亏 | 0（未卖出） | -浮亏金额 |

## 10. 注意事项

1. **跨年持仓成本**：跨年持仓使用期初市价作为估算成本，与实际买入价可能有差异
2. **当年未卖出**：当年未卖出的持仓不计入当年资本利得（未实现盈亏不纳税）
3. **亏损结转**：跨年亏损暂不支持自动结转抵扣
4. **公司行动**：股票拆分、合并等可能影响成本计算
5. **汇率波动**：仅使用年末汇率，不考虑交易当日汇率
6. **滞纳金**：请务必在汇算截止日期前完成缴税，避免产生额外费用
7. **期权乘数**：成交金额已包含乘数，无需手动计算
